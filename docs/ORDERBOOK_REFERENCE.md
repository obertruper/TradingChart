# Справочник: Orderbook Data (Данные стакана)

Документ описывает таблицу `orderbook_bybit_futures_1m` — агрегированные данные стакана (orderbook) с биржи Bybit для фьючерсов.

**Скрипт:** `indicators/orderbook_loader.py`
**Таблица:** `orderbook_bybit_futures_1m`
**Дата создания:** 2026-02-04

---

## Оглавление

1. [Что такое Orderbook](#что-такое-orderbook)
2. [Как собираются данные](#как-собираются-данные)
3. [Структура таблицы](#структура-таблицы)
4. [Группа PRICE — Ценовые данные](#группа-price--ценовые-данные-6-колонок)
5. [Группа SPREAD — Спред](#группа-spread--спред-6-колонок)
6. [Группа BID VOLUME — Объёмы покупателей](#группа-bid-volume--объёмы-покупателей-6-колонок)
7. [Группа ASK VOLUME — Объёмы продавцов](#группа-ask-volume--объёмы-продавцов-6-колонок)
8. [Группа IMBALANCE — Дисбаланс стакана](#группа-imbalance--дисбаланс-стакана-7-колонок)
9. [Группа PRESSURE — Давление](#группа-pressure--давление-2-колонки)
10. [Группа WALLS — Стены](#группа-walls--стены-6-колонок)
11. [Группа SLIPPAGE — Проскальзывание](#группа-slippage--проскальзывание-6-колонок)
12. [Группа LIQUIDITY — Ликвидность](#группа-liquidity--ликвидность-3-колонки)
13. [Группа VOLATILITY — Волатильность внутри минуты](#группа-volatility--волатильность-внутри-минуты-3-колонки)
14. [Группа ACTIVITY — Активность](#группа-activity--активность-5-колонок)
15. [Группа DEPTH LEVELS — Уровни глубины](#группа-depth-levels--уровни-глубины-2-jsonb-колонки)
16. [Правила агрегации](#правила-агрегации)
17. [Применение для анализа и ML](#применение-для-анализа-и-ml)
18. [SQL примеры запросов](#sql-примеры-запросов)

---

## Что такое Orderbook

**Orderbook (стакан)** — это список всех лимитных ордеров на покупку (bids) и продажу (asks), которые выставлены на бирже, но ещё не исполнены.

```
       ASKS (продавцы)                    BIDS (покупатели)
  Цена       Объём                   Цена       Объём
  20730.00   118.599  ← best ask     20729.50   5.137   ← best bid
  20730.50   2.341                    20729.00   8.221
  20731.00   15.002                   20728.50   12.445
  ...        ...                     ...        ...
```

**Best Bid** — лучшая (максимальная) цена покупки. Покупатели готовы купить по этой цене.
**Best Ask** — лучшая (минимальная) цена продажи. Продавцы готовы продать по этой цене.
**Spread** — разница между best ask и best bid. Чем меньше — тем ликвиднее рынок.

### Orderbook vs Candles (свечи)

| Что показывает | Orderbook | Candles (OHLCV) |
|---|:---:|:---:|
| Намерения участников (кто хочет купить/продать) | да | нет |
| Ликвидность рынка | да | нет |
| Глубина стакана (объёмы на уровнях) | да | нет |
| Исполненные сделки | нет | да |
| Общий объём торгов | нет | да |
| Цена открытия/закрытия | нет | да |

Orderbook показывает **что рынок собирается делать** (ожидающие ордера), а свечи — **что уже произошло** (исполненные сделки). Вместе они дают полную картину.

---

## Как собираются данные

### Источник

Исторические архивы Bybit:
```
https://quote-saver.bycsi.com/orderbook/linear/{SYMBOL}/{DATE}_{SYMBOL}_ob{DEPTH}.data.zip
```

### Формат данных в архиве

Каждый ZIP содержит JSON Lines файл (~864,000 строк/день, ~1.6-4 GB).
Сообщения двух типов:

**Snapshot** — полный снимок стакана (все 200-500 уровней bid + ask)
**Delta** — инкрементальное обновление (только изменённые уровни)

Сообщения приходят каждые ~100ms (~600 в минуту).

### Процесс агрегации

```
1 ZIP архив (1 день)
    ↓
864,000 JSON сообщений
    ↓
Восстановление стакана: snapshot → apply delta → apply delta → ...
    ↓
Каждую минуту: состояние стакана + накопленные метрики → 1 строка в БД
    ↓
~1440 строк в БД за 1 день
```

Каждая строка в таблице — это **агрегированные данные за 1 минуту** из ~600 обновлений стакана.

### Доступность данных

| Период | Формат | Глубина стакана |
|---|---|---|
| 2023-01-18 — 2025-08-20 | ob500 | 500 уровней bid + 500 ask |
| 2025-08-21 — текущая дата | ob200 | 200 уровней bid + 200 ask |

---

## Структура таблицы

**Таблица:** `orderbook_bybit_futures_1m`
**Колонок:** 60 (2 ключевых + 58 данных)
**Primary Key:** `(timestamp, symbol)`

| # | Группа | Кол-во колонок | Тип агрегации |
|---|---|---|---|
| 1 | PRICE | 6 | LAST |
| 2 | SPREAD | 6 | LAST + MIN/MAX/AVG/STD |
| 3 | BID VOLUME | 6 | LAST + AVG/STD |
| 4 | ASK VOLUME | 6 | LAST + AVG/STD |
| 5 | IMBALANCE | 7 | LAST + MIN/MAX/AVG/STD + CALC |
| 6 | PRESSURE | 2 | LAST |
| 7 | WALLS | 6 | LAST |
| 8 | SLIPPAGE | 6 | LAST |
| 9 | LIQUIDITY | 3 | LAST |
| 10 | VOLATILITY | 3 | STD + CALC |
| 11 | ACTIVITY | 5 | LAST + COUNT |
| 12 | DEPTH LEVELS | 2 | LAST (JSONB) |
| | **Итого** | **58** | |

---

## Группа PRICE — Ценовые данные (6 колонок)

Базовые цены стакана на конец минуты (LAST — последнее состояние из ~600 обновлений).

### best_bid `DECIMAL(20,8)`

**Лучшая цена покупки** — максимальная цена, по которой покупатели готовы купить.

Это самый верхний уровень в bid-стороне стакана. Маркет-ордер на продажу исполнится по этой цене (или ниже, если объёма на best bid недостаточно).

**Пример:** `20729.50` — покупатели готовы купить BTC за $20,729.50

### best_ask `DECIMAL(20,8)`

**Лучшая цена продажи** — минимальная цена, по которой продавцы готовы продать.

Маркет-ордер на покупку исполнится по этой цене (или выше).

**Пример:** `20730.00` — продавцы готовы продать BTC за $20,730.00

### mid_price `DECIMAL(20,8)`

**Средняя цена** — среднее между best_bid и best_ask.

```
mid_price = (best_bid + best_ask) / 2
```

Считается «справедливой» ценой актива в данный момент. Используется как базовая точка для расчёта расстояний и процентов.

**Пример:** `20729.75` = (20729.50 + 20730.00) / 2

### microprice `DECIMAL(20,8)`

**Взвешенная по объёму цена** — более точная оценка «справедливой» цены, учитывающая объёмы на лучших уровнях.

```
microprice = (best_bid × ask_volume_at_best + best_ask × bid_volume_at_best) / (ask_volume_at_best + bid_volume_at_best)
```

**Логика:** Если на best ask стоит 100 BTC, а на best bid только 1 BTC — цена с большей вероятностью пойдёт вниз (покупателей мало). Microprice сдвигается в сторону уровня с большим объёмом.

**Для анализа:** Разница `microprice - mid_price` показывает направление краткосрочного давления:
- `microprice > mid_price` → давление вверх (больше объёма на bid)
- `microprice < mid_price` → давление вниз (больше объёма на ask)

### vwap_bid `DECIMAL(20,8)`

**VWAP для bid стороны** — средневзвешенная по объёму цена всех bid-уровней стакана.

```
vwap_bid = Σ(price_i × volume_i) / Σ(volume_i)   для всех bid уровней
```

Показывает «центр масс» стороны покупателей. Если vwap_bid значительно ниже best_bid — большая часть объёма стоит далеко от текущей цены (стакан «разрежен» у цены).

### vwap_ask `DECIMAL(20,8)`

**VWAP для ask стороны** — аналогично для продавцов.

**Для анализа:** Расстояние `vwap_ask - vwap_bid` показывает общую ширину «ценового коридора» ликвидности. Чем шире — тем менее ликвидный рынок.

---

## Группа SPREAD — Спред (6 колонок)

Спред — ключевой индикатор ликвидности. Маленький спред = ликвидный рынок, большой = неликвидный.

### spread `DECIMAL(20,8)`

**Спред на конец минуты** — разница между best_ask и best_bid.

```
spread = best_ask - best_bid
```

**Пример:** `0.50` = $0.50 — для BTCUSDT это типичный спред на ликвидном рынке.

### spread_pct `DECIMAL(10,6)`

**Спред в процентах от mid_price.**

```
spread_pct = spread / mid_price × 100
```

Позволяет сравнивать ликвидность разных инструментов. Для BTCUSDT обычно 0.001-0.01%.

### spread_min `DECIMAL(20,8)`

**Минимальный спред за минуту** — самый узкий спред из ~600 обновлений.

Показывает лучшую ликвидность, которая была в течение минуты. Если `spread_min = 0.10` (минимально возможный тик), рынок был очень ликвидный хотя бы в один момент.

### spread_max `DECIMAL(20,8)`

**Максимальный спред за минуту** — самый широкий спред из ~600 обновлений.

**Для анализа:** Если `spread_max >> spread`, в течение минуты был момент низкой ликвидности (стакан «опустел»). Это часто происходит при агрессивных маркет-ордерах, которые «съедают» уровни.

**Пример:** `spread = 0.50`, `spread_max = 4.90` → спред расширился в 10 раз — был момент агрессии.

### spread_avg `DECIMAL(20,8)`

**Средний спред за минуту** — среднее арифметическое всех ~600 значений спреда.

Лучше отражает «типичную» ликвидность минуты, чем LAST (который может быть случайным).

### spread_std `DECIMAL(20,8)`

**Стандартное отклонение спреда за минуту.**

**Для анализа:** Высокий `spread_std` означает нестабильную ликвидность — спред «прыгал» в течение минуты. Это сигнал волатильности на микроуровне.

---

## Группа BID VOLUME — Объёмы покупателей (6 колонок)

Объёмы показывают сколько актива (в BTC, ETH и т.д.) готовы купить на разных расстояниях от текущей цены.

### bid_vol_01pct `DECIMAL(20,8)`

**Объём bid в пределах 0.1% от mid_price.**

Самая «горячая» зона — ордера, стоящие почти вплотную к текущей цене. Это ликвидность, которая будет исполнена при минимальном движении цены.

**Пример:** `5.137` BTC = покупатели готовы купить 5.137 BTC в пределах $20.7 от mid_price.

**Для анализа:** Резкое падение `bid_vol_01pct` — покупатели убирают ордера, возможно ожидая снижения.

### bid_vol_05pct `DECIMAL(20,8)`

**Объём bid в пределах 0.5% от mid_price.**

Средняя глубина стакана. Показывает устойчивость поддержки цены при умеренном давлении продавцов.

### bid_vol_10pct `DECIMAL(20,8)`

**Объём bid в пределах 1.0% от mid_price.**

Общая глубина поддержки. Для BTCUSDT при цене $20K это ±$200 от mid. Показывает сколько нужно продать, чтобы сдвинуть цену на 1%.

### bid_volume `DECIMAL(20,8)`

**Полный объём всех bid-уровней стакана.**

Сумма объёмов на всех 200-500 уровнях. Показывает общее количество лимитных ордеров на покупку.

### bid_vol_avg `DECIMAL(20,8)`

**Средний bid_volume за минуту** — среднее из ~600 значений.

### bid_vol_std `DECIMAL(20,8)`

**Стандартное отклонение bid_volume за минуту.**

**Для анализа:** Высокий `bid_vol_std` означает, что покупатели активно добавляли и убирали ордера в течение минуты — признак неопределённости.

---

## Группа ASK VOLUME — Объёмы продавцов (6 колонок)

Зеркальная группа к BID VOLUME — для стороны продавцов.

### ask_vol_01pct, ask_vol_05pct, ask_vol_10pct `DECIMAL(20,8)`

Объём ордеров на продажу в пределах 0.1%, 0.5% и 1.0% от mid_price. Логика аналогична bid-стороне.

### ask_volume `DECIMAL(20,8)`

**Полный объём всех ask-уровней стакана.**

### ask_vol_avg, ask_vol_std `DECIMAL(20,8)`

Среднее и стандартное отклонение ask_volume за минуту.

**Для анализа (bid vs ask):**
- `bid_volume >> ask_volume` → больше покупателей ждут — бычий сигнал
- `ask_volume >> bid_volume` → больше продавцов ждут — медвежий сигнал
- Сравнивать лучше через `imbalance`, который нормализует разницу

---

## Группа IMBALANCE — Дисбаланс стакана (7 колонок)

Дисбаланс — один из самых ценных сигналов orderbook. Показывает соотношение сил покупателей и продавцов.

### imbalance `DECIMAL(10,6)`

**Дисбаланс стакана на конец минуты.**

```
imbalance = (bid_volume - ask_volume) / (bid_volume + ask_volume)
```

Диапазон: от **-1** (только продавцы) до **+1** (только покупатели).

| Значение | Интерпретация |
|---|---|
| +0.3 ... +1.0 | Сильное давление покупателей |
| +0.05 ... +0.3 | Умеренное давление покупателей |
| -0.05 ... +0.05 | Баланс (нейтральный рынок) |
| -0.3 ... -0.05 | Умеренное давление продавцов |
| -1.0 ... -0.3 | Сильное давление продавцов |

**Для анализа:** Imbalance часто **опережает** движение цены. Рост imbalance (больше покупателей) → цена с большей вероятностью пойдёт вверх.

### imbalance_01pct `DECIMAL(10,6)`

**Дисбаланс в пределах 0.1% от mid_price.**

Считается на ближайших уровнях — более чувствительный и быстрый сигнал, чем `imbalance` по всему стакану.

### imbalance_min `DECIMAL(10,6)`

**Минимальный дисбаланс за минуту** — максимальное давление продавцов в течение минуты.

### imbalance_max `DECIMAL(10,6)`

**Максимальный дисбаланс за минуту** — максимальное давление покупателей в течение минуты.

### imbalance_avg `DECIMAL(10,6)`

**Средний дисбаланс за минуту.**

Лучше отражает «типичное» давление, чем LAST.

### imbalance_std `DECIMAL(10,6)`

**Стандартное отклонение дисбаланса за минуту.**

Высокий `imbalance_std` = давление активно менялось, рынок «метался» между покупателями и продавцами.

### imbalance_range `DECIMAL(10,6)`

**Размах дисбаланса за минуту.**

```
imbalance_range = imbalance_max - imbalance_min
```

**Для анализа:** Большой `imbalance_range` (например, 0.8-1.0) означает, что в течение одной минуты давление качнулось от сильных продавцов к сильным покупателям. Это признак «борьбы» за направление.

---

## Группа PRESSURE — Давление (2 колонки)

Производные метрики давления, рассчитанные из LAST состояния стакана.

### buy_pressure `DECIMAL(10,6)`

**Давление покупателей у цены.**

```
buy_pressure = bid_vol_01pct / ask_vol_01pct
```

| Значение | Интерпретация |
|---|---|
| > 2.0 | Покупатели доминируют у цены |
| 1.0 - 2.0 | Умеренный перевес покупателей |
| 0.5 - 1.0 | Умеренный перевес продавцов |
| < 0.5 | Продавцы доминируют у цены |

**Отличие от imbalance:** buy_pressure считается только на ближайших уровнях (0.1% от цены), не по всему стакану. Более «тактический» сигнал.

### depth_ratio `DECIMAL(10,6)`

**Соотношение глубины стакана.**

```
depth_ratio = bid_vol_10pct / ask_vol_10pct
```

Аналогичная метрика, но на более широком диапазоне (1% от цены). Показывает «стратегический» баланс сил.

**Для анализа:** Если `buy_pressure > 1` но `depth_ratio < 1` — покупатели сильны у цены, но на глубине больше продавцов. Это неустойчивая ситуация.

---

## Группа WALLS — Стены (6 колонок)

Стены — это крупные лимитные ордера, которые могут служить уровнями поддержки или сопротивления.

### bid_wall_price `DECIMAL(20,8)`

**Цена bid-уровня с максимальным объёмом.**

Это уровень, на котором стоит самый крупный ордер на покупку.

### bid_wall_volume `DECIMAL(20,8)`

**Объём на этом уровне (в BTC/ETH и т.д.).**

**Пример:** `bid_wall_price = 20650.00`, `bid_wall_volume = 45.5` → на уровне $20,650 стоит ордер на покупку 45.5 BTC (~$940K).

### bid_wall_distance_pct `DECIMAL(10,6)`

**Расстояние стены от mid_price в процентах.**

```
bid_wall_distance_pct = |mid_price - bid_wall_price| / mid_price × 100
```

**Для анализа:**
- Стена близко к цене (< 0.1%) → сильная ближняя поддержка
- Стена далеко (> 1%) → «стратегический» уровень, но цена может не дойти

### ask_wall_price, ask_wall_volume, ask_wall_distance_pct

Аналогичные метрики для ask стороны (крупнейший ордер на продажу).

**Для анализа:** Стены часто «спуфятся» — крупные игроки выставляют и убирают большие ордера, чтобы создать иллюзию поддержки/сопротивления. Поэтому стены полезнее анализировать в динамике (как меняются от минуты к минуте), а не как статический сигнал.

---

## Группа SLIPPAGE — Проскальзывание (6 колонок)

Slippage показывает насколько цена исполнения отличается от лучшей цены при маркет-ордере заданного размера.

### slippage_buy_10k, slippage_buy_50k, slippage_buy_100k `DECIMAL(20,8)`

**Проскальзывание при покупке на $10K, $50K, $100K.**

Алгоритм: «проходим» по ask-уровням стакана, начиная от лучшего, пока не наберём нужную сумму. Разница между средней ценой исполнения и best_ask — это slippage.

**Пример:** `slippage_buy_100k = 2.30` → при маркет-покупке на $100K средняя цена будет на $2.30 выше best_ask.

### slippage_sell_10k, slippage_sell_50k, slippage_sell_100k `DECIMAL(20,8)`

Аналогично для продажи — проходим по bid-уровням.

**Для анализа:**
- Низкий slippage = глубокий ликвидный стакан
- Высокий slippage = мелкий стакан, маркет-ордер «прожжёт» несколько уровней
- Позволяет оценить реалистичную стоимость входа/выхода при бэктестинге
- Сравнение slippage_buy vs slippage_sell показывает асимметрию ликвидности

**Почему именно $10K/$50K/$100K:**
Эти суммы покрывают типичные размеры позиций — от мелких розничных ($10K) до средних институциональных ($100K).

---

## Группа LIQUIDITY — Ликвидность (3 колонки)

Обобщённые метрики ликвидности стакана.

### liquidity_score `DECIMAL(20,8)`

**Общий показатель ликвидности.**

```
liquidity_score = (bid_volume + ask_volume) / 2
```

Чем выше — тем более ликвидный рынок. Можно отслеживать в динамике: падение liquidity_score предупреждает о снижении ликвидности.

### bid_concentration `DECIMAL(10,6)`

**Концентрация объёма bid в топ-3 уровнях.**

```
bid_concentration = (top_1_vol + top_2_vol + top_3_vol) / total_bid_volume
```

Диапазон: 0 — 1.

| Значение | Интерпретация |
|---|---|
| > 0.5 | Объём сконцентрирован — «стена» или одна крупная заявка |
| 0.1 - 0.3 | Нормальное распределение объёма |
| < 0.1 | Очень равномерное распределение (много мелких ордеров) |

**Для анализа:** Высокая концентрация = хрупкий стакан. Если один крупный ордер будет отменён — ликвидность резко упадёт. Низкая концентрация = устойчивый стакан из множества мелких ордеров.

### ask_concentration `DECIMAL(10,6)`

Аналогично для ask стороны.

---

## Группа VOLATILITY — Волатильность внутри минуты (3 колонки)

Эти метрики показывают что происходило **внутри** минуты — информация, которую невозможно получить из 1-минутной свечи.

### mid_price_range `DECIMAL(20,8)`

**Диапазон mid_price за минуту.**

```
mid_price_range = max(mid_prices) - min(mid_prices)
```

**Пример:** `94.20` → mid_price изменился на $94 внутри одной минуты.

**Для анализа:** Свеча с маленьким телом (close ≈ open) может скрывать огромный `mid_price_range`. Это означает, что цена активно двигалась, но вернулась. Такие минуты — признак борьбы между покупателями и продавцами.

### mid_price_std `DECIMAL(20,8)`

**Стандартное отклонение mid_price за минуту** — из ~600 значений.

Более устойчивая метрика волатильности, чем range (не зависит от выбросов).

### price_momentum `DECIMAL(10,6)`

**Направление движения за минуту.**

```
price_momentum = (last_mid - first_mid) / first_mid
```

| Значение | Интерпретация |
|---|---|
| > 0 | Цена выросла за минуту |
| = 0 | Цена не изменилась |
| < 0 | Цена упала за минуту |

**Для анализа:** Комбинация `price_momentum` + `mid_price_range`:
- Высокий momentum + низкий range → направленное движение (тренд)
- Низкий momentum + высокий range → боковое движение с высокой волатильностью (борьба)

---

## Группа ACTIVITY — Активность (5 колонок)

Метрики частоты обновлений стакана.

### ob_bid_levels `INT`

**Количество ненулевых bid-уровней на конец минуты.**

Для ob500 формата: обычно ~500. Для ob200: ~200. Если значительно меньше — часть уровней «пустые» (были удалены через delta с size=0).

### ob_ask_levels `INT`

**Количество ненулевых ask-уровней на конец минуты.**

### ob_update_count `INT`

**Количество обновлений стакана за минуту.**

Обычно ~590-600. Значительно меньше (< 300) → рынок малоактивен. Значительно больше (> 700) → повышенная активность.

**Для анализа:** Резкий рост `ob_update_count` часто предшествует или сопровождает сильное движение цены — участники активно добавляют/убирают ордера.

### best_bid_changes `INT`

**Сколько раз менялся best_bid за минуту.**

**Пример:** `117` → лучшая цена покупки менялась 117 раз за минуту (в среднем каждые ~0.5 секунды).

### best_ask_changes `INT`

**Сколько раз менялся best_ask за минуту.**

**Для анализа:** Высокий `best_bid_changes` + `best_ask_changes` → цена активно «пилится» на уровне. Это может означать борьбу алгоритмических маркет-мейкеров за лучшую цену.

---

## Группа DEPTH LEVELS — Уровни глубины (2 JSONB колонки)

Полная структура стакана на конец минуты — top 50 ценовых уровней.

### bid_levels `JSONB`

**Top-50 bid уровней, отсортированных по цене (от лучшей к худшей).**

```json
[
  {"p": 20729.50, "v": 5.137},
  {"p": 20729.00, "v": 8.221},
  {"p": 20728.50, "v": 12.445},
  ...
  {"p": 20705.00, "v": 2.333}
]
```

- `p` — цена уровня
- `v` — объём на уровне (в базовой валюте: BTC, ETH и т.д.)

**Сортировка: по цене DESC** (ближайшие к mid первыми).

### ask_levels `JSONB`

**Top-50 ask уровней, отсортированных по цене (от лучшей к худшей).**

```json
[
  {"p": 20730.00, "v": 118.599},
  {"p": 20730.50, "v": 2.341},
  ...
  {"p": 20755.00, "v": 1.005}
]
```

**Сортировка: по цене ASC** (ближайшие к mid первыми).

### Почему Top 50?

Анализ реальных данных (BTCUSDT, 2026-02-01):

| Top-N | % от общего объёма (bid) | % от общего объёма (ask) |
|:---:|:---:|:---:|
| Top 5 | 30.9% | 25.8% |
| Top 10 | 52.8% | 47.6% |
| Top 20 | 79.9% | 75.0% |
| **Top 50** | **96.1%** | **95.7%** |
| Top 100 | 99.5% | 99.5% |

Top 50 покрывает **96% объёма** — остальные 150-450 уровней содержат незначительный объём (< 0.01 BTC каждый).

### Применение JSONB уровней

1. **Профиль стакана для ML** — подать 50 bid + 50 ask уровней как входные фичи нейросети
2. **Поиск крупных ордеров (стен)** — фильтр по `v > threshold`
3. **Анализ плотности** — расстояние между уровнями показывает «дыры» в стакане
4. **Восстановление heatmap** — визуализация стакана по времени

---

## Правила агрегации

Каждая строка в БД — результат агрегации ~600 обновлений стакана за 1 минуту:

| Тип | Описание | Колонки |
|---|---|---|
| **LAST** | Значение из последнего обновления минуты (аналог close) | best_bid, best_ask, mid_price, microprice, vwap, volumes, imbalance, pressure, walls, slippage, liquidity, concentration, JSONB levels |
| **MIN** | Минимум из ~600 значений | spread_min, imbalance_min |
| **MAX** | Максимум из ~600 значений | spread_max, imbalance_max |
| **AVG** | Среднее арифметическое ~600 значений | spread_avg, imbalance_avg, bid_vol_avg, ask_vol_avg |
| **STD** | Стандартное отклонение ~600 значений | spread_std, imbalance_std, bid_vol_std, ask_vol_std, mid_price_std |
| **COUNT** | Подсчёт событий | ob_update_count, best_bid_changes, best_ask_changes |
| **CALC** | Вычисляется из других метрик | imbalance_range, mid_price_range, price_momentum |

---

## Применение для анализа и ML

### Предсказание направления цены

| Фича | Сигнал | Механизм |
|---|---|---|
| `imbalance` растёт | Цена пойдёт вверх | Покупателей становится больше |
| `buy_pressure > 2` | Краткосрочный рост | У цены доминируют покупатели |
| `spread_max` резко вырос | Надвигается волатильность | Ликвидность «испарилась» |
| `mid_price_range` высокий при низком `price_momentum` | Боковик с борьбой | Цена будет «пилить» |
| `bid_concentration` резко упал | Поддержка уходит | Крупный ордер отменён |

### Оценка ликвидности

| Задача | Колонки |
|---|---|
| Стоимость входа в позицию | `slippage_buy_*` |
| Стоимость выхода из позиции | `slippage_sell_*` |
| Оптимальный размер позиции | `slippage_*` при разных суммах |
| Устойчивость ликвидности | `spread_std`, `bid_vol_std`, `ask_vol_std` |
| Хрупкость стакана | `bid_concentration`, `ask_concentration` |

### Обнаружение аномалий

| Аномалия | Признак |
|---|---|
| Flash crash | `mid_price_range >> ATR`, `spread_max` аномально высокий |
| Spoofing (фейковые стены) | `bid_wall_volume` резко появляется/исчезает между минутами |
| Liquidity vacuum | `ob_bid_levels` или `ob_ask_levels` резко падает |
| Aggressive buying | `best_ask_changes >> best_bid_changes`, `price_momentum > 0` |

### Бэктестинг

Orderbook данные позволяют проводить **реалистичный бэктестинг**:

- **Slippage**: не фиксированный 0.1%, а реальный по стакану в момент входа
- **Market impact**: можно оценить как ваш ордер сдвинул бы цену
- **Fill probability**: можно оценить вероятность исполнения лимитного ордера на уровне стены
- **Optimal execution**: VWAP/TWAP стратегии с реальной ликвидностью

---

## SQL примеры запросов

### Базовая статистика

```sql
-- Количество записей по дням
SELECT DATE(timestamp) as day, COUNT(*) as rows
FROM orderbook_bybit_futures_1m
WHERE symbol = 'BTCUSDT'
GROUP BY DATE(timestamp) ORDER BY day;
```

### Поиск моментов низкой ликвидности

```sql
-- Минуты когда спред расширился более чем в 10 раз
SELECT timestamp, spread, spread_max,
       ROUND(spread_max / NULLIF(spread, 0), 1) as spread_expansion
FROM orderbook_bybit_futures_1m
WHERE symbol = 'BTCUSDT'
  AND spread_max > spread * 10
ORDER BY spread_expansion DESC
LIMIT 20;
```

### Анализ дисбаланса перед движением цены

```sql
-- Imbalance vs следующее движение цены
SELECT
    a.timestamp,
    a.imbalance,
    a.mid_price,
    b.mid_price as next_mid,
    b.mid_price - a.mid_price as price_change
FROM orderbook_bybit_futures_1m a
JOIN orderbook_bybit_futures_1m b
    ON b.timestamp = a.timestamp + INTERVAL '1 minute'
    AND b.symbol = a.symbol
WHERE a.symbol = 'BTCUSDT'
  AND ABS(a.imbalance) > 0.3
ORDER BY a.timestamp DESC
LIMIT 50;
```

### Извлечение данных из JSONB

```sql
-- Получить top-5 bid уровней для конкретной минуты
SELECT
    timestamp,
    level->>'p' as price,
    level->>'v' as volume
FROM orderbook_bybit_futures_1m,
     jsonb_array_elements(bid_levels) WITH ORDINALITY arr(level, idx)
WHERE symbol = 'BTCUSDT'
  AND timestamp = '2023-01-19 12:00:00+00'
  AND idx <= 5;
```

### Поиск крупных стен

```sql
-- Стены > 50 BTC
SELECT timestamp, bid_wall_price, bid_wall_volume, bid_wall_distance_pct
FROM orderbook_bybit_futures_1m
WHERE symbol = 'BTCUSDT'
  AND bid_wall_volume > 50
ORDER BY bid_wall_volume DESC
LIMIT 20;
```

---

## Технические детали

| Параметр | Значение |
|---|---|
| Таблица | `orderbook_bybit_futures_1m` |
| Primary Key | `(timestamp, symbol)` |
| Индексы | `(symbol, timestamp)`, `(timestamp)` |
| Колонок | 60 (2 ключевых + 56 числовых + 2 JSONB) |
| Байт/строка | ~3,000 |
| Строк/день | 1,440 |
| Размер/год/символ | ~1.6 GB |
| Скрипт | `indicators/orderbook_loader.py` |
| Источник | `quote-saver.bycsi.com/orderbook/linear/` |
| Первые данные | 2023-01-18 |
