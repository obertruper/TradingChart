# SMA (Simple Moving Average) - Простая скользящая средняя

## Оглавление

1. [Что такое SMA?](#что-такое-sma)
2. [Зачем нужен SMA?](#зачем-нужен-sma)
3. [Формула расчета](#формула-расчета)
4. [Как работает SMA](#как-работает-sma)
   - [Почему SMA работает на рынке](#почему-sma-работает-на-рынке)
   - [Задержка (лаг) индикатора](#задержка-лаг-индикатора)
   - [Влияние периода на чувствительность](#влияние-периода-на-чувствительность)
5. [Периоды SMA в нашей системе](#периоды-sma-в-нашей-системе)
6. [Реализация в проекте](#реализация-в-проекте)
   - [Аргументы командной строки](#аргументы-командной-строки)
   - [Режимы работы](#режимы-работы)
7. [База данных](#база-данных)
8. [Автоматическое обновление данных](#автоматическое-обновление-данных)
9. [Применение в трейдинге](#применение-в-трейдинге)
   - [Популярные стратегии](#популярные-стратегии)
   - [Расширенные стратегии](#расширенные-стратегии)
   - [Практические примеры торговли](#практические-примеры-торговли)
   - [Как избежать ложных сигналов](#как-избежать-ложных-сигналов)
   - [Управление позицией](#управление-позицией)
10. [Преимущества и недостатки](#преимущества-и-недостатки)
11. [Валидация данных](#валидация-данных)
12. [История изменений](#история-изменений)

---

## Что такое SMA?

### Простое объяснение

**SMA (Simple Moving Average)** — это среднее арифметическое цен за определенный период времени.

**Аналогия из жизни:** Представьте, что вы каждый день записываете температуру воздуха. Чтобы понять, какая погода была "в среднем" за последнюю неделю, вы складываете температуру за 7 дней и делите на 7. Это и есть "скользящая средняя" — она "скользит" по времени, каждый день добавляя новое значение и убирая самое старое.

### Визуализация

```
Цена:  100  102  98  105  103  101  99  104  106  102
                                              ↓
SMA(5) для последней точки = (101 + 99 + 104 + 106 + 102) / 5 = 102.4
```

SMA сглаживает резкие колебания цены и показывает общий тренд движения.

---

## Зачем нужен SMA?

SMA используется для:

| Цель | Описание |
|------|----------|
| **Определение тренда** | Если цена выше SMA — тренд восходящий, ниже — нисходящий |
| **Уровни поддержки/сопротивления** | SMA часто работает как динамический уровень, от которого цена отскакивает |
| **Фильтрация шума** | Убирает случайные колебания, показывая "истинное" направление движения |
| **Генерация сигналов** | Пересечение двух SMA (короткой и длинной) дает сигналы на покупку/продажу |

---

## Формула расчета

### Математическая формула

```
SMA(n) = (P₁ + P₂ + P₃ + ... + Pₙ) / n
```

**Где:**
- `n` — период (количество свечей для расчета)
- `P` — цена (в нашей системе используется цена закрытия — CLOSE)

### Пример расчета SMA(5)

| Свеча | Цена закрытия (CLOSE) |
|-------|----------------------|
| 1     | 100.00               |
| 2     | 102.50               |
| 3     | 98.75                |
| 4     | 105.00               |
| 5     | 103.25               |

```
SMA(5) = (100.00 + 102.50 + 98.75 + 105.00 + 103.25) / 5 = 101.90
```

### Как реализовано в коде проекта

```python
# Файл: indicators/sma_loader.py, строка 566
df[f'sma_{period}'] = df['close'].rolling(window=period, min_periods=period).mean()
```

**Объяснение:**
- `rolling(window=period)` — создает "скользящее окно" размером `period` свечей
- `min_periods=period` — расчет начинается только когда накоплено достаточно данных
- `.mean()` — вычисляет среднее арифметическое

---

## Как работает SMA

### Почему SMA работает на рынке

SMA — это не просто математическая формула. Он работает благодаря **психологии рынка**:

**Самосбывающееся пророчество:**
Миллионы трейдеров по всему миру смотрят на одни и те же уровни SMA (особенно 50 и 200). Когда цена приближается к SMA 200, многие начинают покупать — и цена действительно отскакивает. Это работает потому, что все ожидают, что это сработает.

**Институциональные трейдеры:**
Крупные фонды и банки часто используют SMA 200 как ориентир для принятия решений. Когда актив падает ниже SMA 200, они начинают продавать. Это создаёт реальное давление на цену и усиливает движение.

**Исторический контекст:**
SMA — один из старейших индикаторов (использовался ещё до компьютеров). За десятилетия он стал стандартом, который знают все — от новичков до профессионалов.

---

### Задержка (лаг) индикатора

SMA — это **запаздывающий индикатор**. Он показывает прошлое, а не будущее. Чем больше период, тем сильнее задержка:

| Период | Средняя задержка | Характеристика |
|--------|------------------|----------------|
| SMA 10 | ~5 свечей | Быстрая реакция, но много шума |
| SMA 30 | ~15 свечей | Баланс скорости и сглаживания |
| SMA 50 | ~25 свечей | Хороший фильтр среднесрочного тренда |
| SMA 100 | ~50 свечей | Надёжный, но медленный |
| SMA 200 | ~100 свечей | Самый надёжный, но самый медленный |

**Формула задержки:**
```
Средняя задержка ≈ Период / 2
```

**Пример:** SMA 200 на часовом графике имеет задержку около 100 часов (~4 дня). Это значит, что разворот тренда вы увидите с опозданием в несколько дней.

---

### Влияние периода на чувствительность

```
Короткий период (10-30):
├── ✅ Быстро реагирует на изменения цены
├── ✅ Линия ближе к текущей цене
├── ❌ Много ложных сигналов
└── ❌ "Шумит" в боковом движении (флэт)

Длинный период (100-200):
├── ✅ Хорошо фильтрует рыночный шум
├── ✅ Надёжные сигналы разворота
├── ❌ Сильно запаздывает за ценой
└── ❌ Поздние входы — упускаете часть движения
```

### Как выбрать период

| Стиль торговли | Рекомендуемые периоды |
|----------------|----------------------|
| Скальпинг (минуты) | SMA 10, SMA 30 |
| Дейтрейдинг (часы) | SMA 30, SMA 50 |
| Свинг (дни) | SMA 50, SMA 100 |
| Позиционная (недели) | SMA 100, SMA 200 |
| Инвестиции (месяцы) | SMA 200 |

---

## Периоды SMA в нашей системе

В проекте используются 5 периодов SMA:

| Период | Название | Назначение | Применение |
|--------|----------|------------|------------|
| **SMA 10** | Краткосрочный | Быстрая реакция на изменения | Скальпинг, внутридневная торговля |
| **SMA 30** | Краткосрочный | Баланс между скоростью и сглаживанием | Дейтрейдинг |
| **SMA 50** | Среднесрочный | Стандартный период для свинг-трейдинга | Свинг-трейдинг (дни-недели) |
| **SMA 100** | Среднесрочный | Фильтрация среднесрочного тренда | Позиционная торговля |
| **SMA 200** | Долгосрочный | "Золотой стандарт" долгосрочного тренда | Инвестиции, определение глобального тренда |

### Конфигурация (indicators_config.yaml)

```yaml
indicators:
  sma:
    enabled: true
    periods: [10, 30, 50, 100, 200]
```

---

## Реализация в проекте

### Архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                         SMA LOADER                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. ЗАГРУЗКА КОНФИГА                                            │
│     indicators_config.yaml → периоды, символы, таймфреймы       │
│                                                                  │
│  2. СОЗДАНИЕ КОЛОНОК В БД                                       │
│     ALTER TABLE → sma_10, sma_30, sma_50, sma_100, sma_200      │
│                                                                  │
│  3. ЗАГРУЗКА СВЕЧЕЙ                                             │
│     candles_bybit_futures_1m → DataFrame с OHLCV                │
│                                                                  │
│  4. АГРЕГАЦИЯ (для 15m, 1h)                                     │
│     1m свечи → группировка → последняя цена закрытия периода    │
│                                                                  │
│  5. РАСЧЕТ SMA                                                  │
│     pandas.rolling().mean() для каждого периода                 │
│                                                                  │
│  6. ЗАПИСЬ В БД                                                 │
│     INSERT...ON CONFLICT DO UPDATE → indicators_bybit_futures_* │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Файлы проекта

| Файл | Назначение |
|------|------------|
| `indicators/sma_loader.py` | Основной загрузчик SMA |
| `indicators/indicators_config.yaml` | Конфигурация (периоды, символы) |
| `indicators/tests/check_full_data/check_sma_data.py` | Валидатор математической корректности |
| `indicators/start_all_loaders.py` | Оркестратор для запуска всех индикаторов |

### Поддерживаемые таймфреймы

| Таймфрейм | Источник данных | Агрегация |
|-----------|-----------------|-----------|
| **1m** | candles_bybit_futures_1m | Прямое чтение |
| **15m** | candles_bybit_futures_1m | Агрегация из 1m (15 свечей → 1) |
| **1h** | candles_bybit_futures_1m | Агрегация из 1m (60 свечей → 1) |

### Обработка символов

Поддерживаемые торговые пары:
- BTCUSDT, ETHUSDT, BNBUSDT, XRPUSDT, SOLUSDT
- ADAUSDT, LINKUSDT, XLMUSDT, LTCUSDT, DOTUSDT

### Команды запуска

```bash
cd indicators
python3 sma_loader.py [опции]
```

---

### Аргументы командной строки

| Аргумент | Тип | По умолчанию | Описание |
|----------|-----|--------------|----------|
| `--symbol` | строка | из config | Одна торговая пара (например, `BTCUSDT`) |
| `--symbols` | строка | из config | Несколько пар через запятую (`BTCUSDT,ETHUSDT`) |
| `--timeframe` | строка | из config | Один таймфрейм (`1m`, `15m`, `1h`) |
| `--timeframes` | строка | из config | Несколько таймфреймов через запятую |
| `--batch-days` | число | 30 | Размер батча в днях для обработки |
| `--force-reload` | флаг | false | **Полный пересчет с начала истории** |

---

### Режимы работы

#### 1. Инкрементальный режим (по умолчанию)

Загружает только **новые данные** с момента последнего обновления.

```bash
python3 sma_loader.py
```

**Как работает:**
1. Находит последнюю дату, где SMA уже рассчитан
2. Загружает свечи только с этой даты
3. Рассчитывает SMA для новых данных
4. Дописывает результаты в БД (UPSERT)

**Когда использовать:** Ежедневное обновление, автоматизация через cron.

---

#### 2. Режим полного пересчета (--force-reload)

Удаляет все существующие SMA данные и пересчитывает **с самого начала истории**.

```bash
python3 sma_loader.py --force-reload
```

**Как работает:**
1. Обнуляет все SMA столбцы (устанавливает NULL) для выбранного символа
2. Загружает ВСЕ свечи с начала истории
3. Рассчитывает SMA для всего периода
4. Записывает результаты в БД

**Когда использовать:**
- После исправления багов в расчетах
- При изменении логики агрегации
- Для гарантии целостности данных
- При первоначальной загрузке

> **Внимание:** Полный пересчет для одного символа может занять несколько часов для 1m таймфрейма (миллионы записей).

---

#### 3. Режим конкретного символа

Обрабатывает только указанный символ.

```bash
# Один символ
python3 sma_loader.py --symbol BTCUSDT

# Несколько символов
python3 sma_loader.py --symbols BTCUSDT,ETHUSDT,SOLUSDT
```

---

#### 4. Режим конкретного таймфрейма

Обрабатывает только указанный таймфрейм.

```bash
# Только часовые данные
python3 sma_loader.py --timeframe 1h

# Несколько таймфреймов
python3 sma_loader.py --timeframes 15m,1h
```

---

#### 5. Комбинированные режимы

Аргументы можно комбинировать:

```bash
# Полный пересчет только для BTCUSDT на 1h
python3 sma_loader.py --symbol BTCUSDT --timeframe 1h --force-reload

# Инкрементальное обновление для нескольких символов на 15m
python3 sma_loader.py --symbols BTCUSDT,ETHUSDT --timeframe 15m

# Увеличенный батч для ускорения (меньше коммитов в БД)
python3 sma_loader.py --batch-days 60
```

---

### Примеры использования

| Задача | Команда |
|--------|---------|
| Ежедневное обновление всех данных | `python3 sma_loader.py` |
| Полный пересчет после исправления бага | `python3 sma_loader.py --force-reload` |
| Быстрая проверка на одном символе | `python3 sma_loader.py --symbol BTCUSDT --timeframe 1h` |
| Пересчет только 15m данных | `python3 sma_loader.py --timeframe 15m --force-reload` |
| Запуск через оркестратор | `python3 start_all_loaders.py` |

---

## База данных

### Таблицы

| Таблица | Таймфрейм | Примерный размер |
|---------|-----------|------------------|
| `indicators_bybit_futures_1m` | 1 минута | ~113 GB |
| `indicators_bybit_futures_15m` | 15 минут | ~7.6 GB |
| `indicators_bybit_futures_1h` | 1 час | ~2 GB |

### Структура колонок SMA

```sql
-- Колонки SMA в таблицах indicators_bybit_futures_*
sma_10   DECIMAL(20,8)   -- SMA с периодом 10
sma_30   DECIMAL(20,8)   -- SMA с периодом 30
sma_50   DECIMAL(20,8)   -- SMA с периодом 50
sma_100  DECIMAL(20,8)   -- SMA с периодом 100
sma_200  DECIMAL(20,8)   -- SMA с периодом 200
```

### Первичный ключ

```sql
PRIMARY KEY (timestamp, symbol)
```

### Пример данных

```sql
SELECT timestamp, symbol, sma_10, sma_50, sma_200
FROM indicators_bybit_futures_1h
WHERE symbol = 'BTCUSDT'
ORDER BY timestamp DESC
LIMIT 5;
```

| timestamp | symbol | sma_10 | sma_50 | sma_200 |
|-----------|--------|--------|--------|---------|
| 2025-12-19 10:00 | BTCUSDT | 104523.45 | 103890.12 | 98765.43 |
| 2025-12-19 09:00 | BTCUSDT | 104498.32 | 103875.89 | 98760.21 |
| ... | ... | ... | ... | ... |

### Механизм записи (Upsert)

```sql
INSERT INTO indicators_bybit_futures_1h (timestamp, symbol, sma_10, sma_30, sma_50, sma_100, sma_200)
VALUES (%s, %s, %s, %s, %s, %s, %s)
ON CONFLICT (timestamp, symbol) DO UPDATE SET
    sma_10 = EXCLUDED.sma_10,
    sma_30 = EXCLUDED.sma_30,
    sma_50 = EXCLUDED.sma_50,
    sma_100 = EXCLUDED.sma_100,
    sma_200 = EXCLUDED.sma_200;
```

---

## Автоматическое обновление данных

### Архитектура сбора данных

Система состоит из двух уровней:

| Уровень | Скрипт | Частота | Что делает |
|---------|--------|---------|------------|
| **1. Сбор свечей** | `monitor.py` | Постоянно (daemon) | Собирает 1m свечи в реальном времени от Bybit API |
| **2. Расчет индикаторов** | `start_all_loaders.py` | Раз в день (01:00 UTC) | Рассчитывает SMA и другие индикаторы на основе свечей |

### Сбор 1m свечей (real-time)

Скрипт `monitor.py` работает в режиме daemon на VPS:
- Постоянно следит за новыми свечами от Bybit API
- Записывает 1m свечи в таблицу `candles_bybit_futures_1m`
- Автоматически заполняет пропуски (gaps)
- Задержка: 1-2 минуты от биржи

### Расчет индикаторов (ежедневно)

| Параметр | Значение |
|----------|----------|
| **Расписание** | `0 1 * * *` (каждый день в 01:00 UTC) |
| **Скрипт** | `start_all_loaders.py` |
| **Время сервера** | UTC 0 |

Оркестратор последовательно запускает все loader'ы:
SMA → EMA → RSI → VMA → ATR → MACD → ...

### Часовой пояс и данные

> **ВАЖНО:** Сервер VPS работает на **UTC 0**. Все данные в базе данных хранятся в UTC без корректировки по часовым поясам.

| Аспект | Описание |
|--------|----------|
| **Тип колонки timestamp** | `TIMESTAMPTZ` (timestamp with timezone) |
| **Часовой пояс** | UTC 0 |
| **Корректировка** | Не требуется — все данные уже в UTC |

**Пример timestamp в БД:**
```
2025-12-19 01:15:00+00  ← "+00" означает UTC
```

---

## Применение в трейдинге

### Определение тренда

| Ситуация | Интерпретация |
|----------|---------------|
| Цена **выше** SMA | Восходящий тренд (бычий) |
| Цена **ниже** SMA | Нисходящий тренд (медвежий) |
| SMA **растет** | Тренд усиливается вверх |
| SMA **падает** | Тренд усиливается вниз |

### Популярные стратегии

#### 1. Золотой крест (Golden Cross)

**Сигнал:** SMA 50 пересекает SMA 200 **снизу вверх**

**Интерпретация:** Сильный бычий сигнал, начало долгосрочного восходящего тренда

```sql
-- SQL для поиска Golden Cross
SELECT timestamp
FROM indicators_bybit_futures_1h
WHERE symbol = 'BTCUSDT'
  AND sma_50 > sma_200
  AND LAG(sma_50) OVER (ORDER BY timestamp) <= LAG(sma_200) OVER (ORDER BY timestamp);
```

#### 2. Мертвый крест (Death Cross)

**Сигнал:** SMA 50 пересекает SMA 200 **сверху вниз**

**Интерпретация:** Сильный медвежий сигнал, начало долгосрочного нисходящего тренда

#### 3. Выстроенные SMA

**Сигнал:** Все SMA выстроены по порядку: 10 > 30 > 50 > 100 > 200

**Интерпретация:** Сильный устойчивый тренд

```sql
-- SQL для поиска сильного бычьего тренда
SELECT timestamp, close
FROM indicators_bybit_futures_1h
WHERE symbol = 'BTCUSDT'
  AND sma_10 > sma_30
  AND sma_30 > sma_50
  AND sma_50 > sma_100
  AND sma_100 > sma_200
ORDER BY timestamp DESC;
```

---

### Расширенные стратегии

#### 4. SMA как динамическая поддержка/сопротивление

В восходящем тренде цена часто "отскакивает" от SMA вверх. В нисходящем — отскакивает вниз. SMA работает как "плавающий" уровень поддержки или сопротивления.

**Условия для входа на отскок (лонг):**
1. Тренд подтверждён — цена выше SMA 200
2. Цена касается SMA 50 или SMA 100 сверху
3. Формируется свеча отскока (молот, длинная нижняя тень)
4. Желательно: объём на отскоке выше среднего

```sql
-- SQL: Поиск касаний SMA 50 в восходящем тренде
SELECT timestamp, close, sma_50, sma_200
FROM indicators_bybit_futures_1h
WHERE symbol = 'BTCUSDT'
  AND close > sma_200                      -- глобальный аптренд
  AND ABS(close - sma_50) / sma_50 < 0.01  -- цена в пределах 1% от SMA 50
ORDER BY timestamp DESC
LIMIT 20;
```

#### 5. Угол наклона SMA

Угол наклона линии SMA показывает силу текущего тренда:

| Наклон | Интерпретация | Рекомендация |
|--------|---------------|--------------|
| Крутой вверх (>2% за 10 свечей) | Сильный бычий тренд | Держать лонги, не шортить |
| Пологий вверх | Слабый/затухающий тренд | Осторожность, возможен разворот |
| Горизонтальный | Флэт (боковое движение) | Не торговать по тренду |
| Пологий вниз | Слабый медвежий тренд | Осторожность |
| Крутой вниз | Сильный медвежий тренд | Держать шорты, не лонговать |

```sql
-- SQL: Оценка наклона SMA 50 (изменение за 10 периодов)
SELECT
    timestamp,
    sma_50,
    LAG(sma_50, 10) OVER (ORDER BY timestamp) as sma_50_prev,
    ROUND(((sma_50 - LAG(sma_50, 10) OVER (ORDER BY timestamp)) /
           LAG(sma_50, 10) OVER (ORDER BY timestamp)) * 100, 2) as slope_percent
FROM indicators_bybit_futures_1h
WHERE symbol = 'BTCUSDT'
ORDER BY timestamp DESC
LIMIT 20;
```

#### 6. Расстояние цена-SMA (Mean Reversion)

Когда цена слишком далеко отходит от SMA, она имеет тенденцию возвращаться обратно. Это явление называется **возврат к среднему** (mean reversion).

| Отклонение от SMA 200 | Интерпретация | Действие |
|-----------------------|---------------|----------|
| < 5% | Нормальное состояние | Следовать тренду |
| 5-10% | Начало перегрева | Быть осторожным |
| 10-20% | Перекупленность/перепроданность | Не открывать новые позиции |
| > 20% | Экстремальное отклонение | Ожидать откат к SMA |

```sql
-- SQL: Поиск экстремальных отклонений от SMA 200
SELECT
    timestamp,
    close,
    sma_200,
    ROUND(((close - sma_200) / sma_200) * 100, 2) as deviation_percent
FROM indicators_bybit_futures_1h
WHERE symbol = 'BTCUSDT'
  AND sma_200 IS NOT NULL
  AND ABS((close - sma_200) / sma_200) > 0.15  -- отклонение > 15%
ORDER BY timestamp DESC
LIMIT 20;
```

#### 7. Веер SMA (SMA Fan)

Когда несколько SMA расходятся веером — это признак сильного тренда. Когда сходятся — тренд ослабевает.

**Бычий веер (сильный аптренд):**
```
Порядок сверху вниз:
  Цена
    ↓
  SMA 10
    ↓
  SMA 30
    ↓
  SMA 50
    ↓
  SMA 100
    ↓
  SMA 200

Расстояние между линиями увеличивается = тренд набирает силу
```

**Схождение веера (ослабление тренда):**
```
Когда SMA начинают сближаться друг к другу:
→ Тренд теряет силу
→ Возможна консолидация или разворот
→ Время фиксировать прибыль
```

#### 8. Мультитаймфрейм анализ

Используй SMA на разных таймфреймах для подтверждения сигналов:

| Таймфрейм | Какой SMA смотреть | Назначение |
|-----------|-------------------|------------|
| 1h | SMA 200 | Определение глобального тренда |
| 15m | SMA 50 | Подтверждение направления входа |
| 1m | SMA 10 | Точный тайминг входа в позицию |

**Правило трёх экранов:**
1. **Старший ТФ (1h):** Определи направление тренда по SMA 200
2. **Средний ТФ (15m):** Дождись отката к SMA 50 в направлении тренда
3. **Младший ТФ (1m):** Входи на развороте от SMA 10

> **Главное правило:** Открывай сделку на младшем таймфрейме только в направлении тренда на старшем.

---

### Практические примеры торговли

#### Пример 1: Вход на Golden Cross

**Ситуация:** SMA 50 пересекает SMA 200 снизу вверх на часовом графике BTCUSDT

**Пошаговый план:**

| Шаг | Действие | Проверка |
|-----|----------|----------|
| 1 | Дождаться пересечения | SMA 50 > SMA 200 |
| 2 | Подтвердить объёмом | Объём выше среднего |
| 3 | Дождаться отката | Цена откатывает к SMA 50 |
| 4 | Войти в лонг | На свече отскока от SMA 50 |

**Точка входа:** Закрытие первой бычьей свечи после касания SMA 50

**Стоп-лосс:** На 1-2% ниже SMA 200 (или под последним локальным минимумом)

**Тейк-профит:**
- TP1: Расстояние стоп-лосса × 2 (Risk:Reward = 1:2)
- TP2: Следующий исторический уровень сопротивления

#### Пример 2: Отскок от SMA 50

**Ситуация:** BTC в восходящем тренде, цена откатила к SMA 50

**Условия для входа:**
```
✅ Цена выше SMA 200 (глобальный аптренд)
✅ Цена касается SMA 50 сверху
✅ Появляется бычья свеча (молот, поглощение)
✅ RSI не в зоне перекупленности (< 70)
✅ Объём на свече отскока повышен
```

**Точка входа:** На закрытии бычьей свечи отскока

**Стоп-лосс:** Под SMA 100 (следующий уровень поддержки)

**Тейк-профит:** Предыдущий локальный максимум

---

### Как избежать ложных сигналов

**Фильтры для отсева плохих сделок:**

| Фильтр | Правило | Почему важно |
|--------|---------|--------------|
| **Объём** | Сигнал должен быть на повышенном объёме | Объём = подтверждение участников |
| **RSI** | Не входить при RSI > 70 или RSI < 30 | Рынок уже перегрет |
| **Угол SMA** | Не торговать при горизонтальном SMA | Нет тренда = нет движения |
| **Касания** | После 3+ касаний уровень "изнашивается" | Вероятность пробоя растёт |
| **Новости** | Не открывать позиции перед важными событиями | Высокая волатильность |
| **Время суток** | Избегать азиатской сессии для BTC | Низкая ликвидность |

---

### Управление позицией

**Трейлинг-стоп по SMA:**

Используй SMA как динамический уровень для переноса стоп-лосса:

```
1. Открыл лонг выше SMA 50
   └── Стоп: под SMA 100

2. Цена выросла, SMA 50 догнал цену
   └── Переношу стоп: под SMA 50

3. Цена ещё выросла, SMA 30 догнал цену
   └── Переношу стоп: под SMA 30

4. Цена пробила SMA 10 вниз
   └── Выход из позиции
```

**Частичная фиксация прибыли:**

```
Структура позиции:
├── 50% — закрыть на TP1 (Risk:Reward = 1:2)
├── 30% — закрыть на TP2 (Risk:Reward = 1:3)
└── 20% — держать с трейлинг-стопом по SMA

Преимущества:
✅ Гарантируешь прибыль на части позиции
✅ Даёшь "бежать" остатку при сильном движении
✅ Снижаешь эмоциональное давление
```

---

## Преимущества и недостатки

### Преимущества

| # | Преимущество |
|---|--------------|
| 1 | Простота расчета и понимания |
| 2 | Хорошо работает в трендовых движениях |
| 3 | Надежные сигналы на старших таймфреймах |
| 4 | Широко используется институциональными трейдерами |
| 5 | Легко комбинируется с другими индикаторами |

### Недостатки

| # | Недостаток |
|---|------------|
| 1 | **Запаздывающий индикатор** — показывает прошлое, а не будущее |
| 2 | Много ложных сигналов в боковом движении (флэт) |
| 3 | Все периоды имеют одинаковый вес (старые данные = новые) |
| 4 | Медленно реагирует на резкие изменения цены |

### Сравнение с EMA

| Характеристика | SMA | EMA |
|----------------|-----|-----|
| Реакция на изменения | Медленная | Быстрая |
| Вес последних данных | Одинаковый | Повышенный |
| Ложные сигналы | Меньше | Больше |
| Лучше для | Долгосрочный тренд | Краткосрочная торговля |

---

## Валидация данных

Для проверки корректности расчетов используется скрипт валидации:

```bash
cd indicators/tests/check_full_data

# Полная валидация всех SMA
python3 check_sma_data.py

# Конкретный символ
python3 check_sma_data.py --symbol BTCUSDT

# Последние 30 дней
python3 check_sma_data.py --days 30

# С подробным выводом
python3 check_sma_data.py --verbose
```

**Что проверяет валидатор:**
- Математическая корректность (пересчитывает SMA и сравнивает с БД)
- Полнота данных (нет пропусков)
- Корректность warm-up периода (первые N-1 значений должны быть NULL)

---

## История изменений

| Дата | Изменение |
|------|-----------|
| 2025-12-17 | Исправлен баг агрегации timestamp для 15m и 1h таймфреймов |
| 2025-11 | Добавлен флаг --force-reload для полного пересчета |
| 2025-10 | Первоначальная реализация SMA loader |
